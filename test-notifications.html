<!doctype html>
<html lang="it">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Test Notifiche - CAlcio Balilla</title>
  <meta name="description" content="CA Biliardino Championship - Test Notifiche" />
  <meta name="theme-color" content="#0b0e14" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" type="image/png" href="./icons/icon-192.jpg" />
  <link rel="apple-touch-icon" href="./icons/icon-192.jpg" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap"
    rel="stylesheet" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Space Grotesk', 'Helvetica Neue', sans-serif;
      background: #0b0e14;
      color: #e8e8ed;
      min-height: 100vh;
      padding: 1.5rem;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      width: 100%;
      max-width: 960px;
      background: #0f131a;
      border: 1px solid #1f2530;
      border-radius: 14px;
      padding: 1.75rem;
      box-shadow: 0 18px 48px rgba(0, 0, 0, 0.35);
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    h1 {
      color: #f6f7fb;
      font-size: 1.6rem;
      letter-spacing: -0.01em;
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .nav-link {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      color: #c4c9d4;
      text-decoration: none;
      font-weight: 500;
      font-size: 0.95rem;
      width: fit-content;
    }

    .nav-link:hover {
      color: #e8e8ed;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
      width: 100%;
    }

    .section {
      padding: 1.1rem;
      background: #111722;
      border: 1px solid #1f2530;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    h2 {
      color: #e8e8ed;
      font-size: 1.05rem;
      letter-spacing: -0.01em;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    label {
      font-weight: 500;
      color: #c4c9d4;
      font-size: 0.95rem;
    }

    input,
    textarea,
    select {
      width: 100%;
      padding: 0.75rem 0.85rem;
      border: 1px solid #1f2530;
      border-radius: 10px;
      font-family: inherit;
      font-size: 1rem;
      background: #0c1018;
      color: #f6f7fb;
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: #4da1ff;
      box-shadow: 0 0 0 3px rgba(77, 161, 255, 0.15);
    }

    textarea {
      resize: vertical;
      min-height: 96px;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .checkbox-group input[type="checkbox"] {
      width: auto;
    }

    button {
      background: linear-gradient(90deg, #1f8aed, #6366f1);
      color: #f6f7fb;
      border: none;
      padding: 0.9rem 1.2rem;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      width: 100%;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 28px rgba(28, 100, 242, 0.25);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .status {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 10px;
      display: none;
    }

    .status.success {
      background: rgba(46, 204, 113, 0.12);
      color: #8ff0c9;
      border: 1px solid rgba(46, 204, 113, 0.35);
      display: block;
    }

    .status.error {
      background: rgba(255, 99, 132, 0.12);
      color: #ffb3c2;
      border: 1px solid rgba(255, 99, 132, 0.35);
      display: block;
    }

    .info-box {
      background: #0c1018;
      border: 1px solid #1f2530;
      padding: 0.85rem 1rem;
      border-radius: 10px;
      color: #c4c9d4;
    }

    .info-box p {
      margin: 0.35rem 0;
    }

    .actions-container {
      border: 1px dashed #2b3240;
      padding: 0.85rem;
      border-radius: 10px;
      background: #0c1018;
    }

    .action-item {
      display: flex;
      gap: 1rem;
      margin-bottom: 0.5rem;
      align-items: center;
    }

    .action-item input {
      flex: 1;
    }

    .action-item button {
      width: auto;
      padding: 0.5rem 0.9rem;
      background: #1f2530;
      border: 1px solid #2f3746;
    }

    .add-action-btn {
      background: #1f8aed;
      margin-top: 0.5rem;
    }

    .code-block {
      background: #0c1018;
      color: #c8d1e0;
      padding: 1rem;
      border-radius: 10px;
      overflow-x: auto;
      font-family: 'JetBrains Mono', 'SFMono-Regular', ui-monospace, Menlo, monospace;
      font-size: 0.9rem;
      margin-top: 0.35rem;
      border: 1px solid #1f2530;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.45rem 0.75rem;
      background: #121725;
      border: 1px solid #1f2530;
      border-radius: 999px;
      color: #c4c9d4;
      font-size: 0.9rem;
      width: fit-content;
    }

    .section small {
      color: #8a90a3;
    }

    @media (max-width: 720px) {
      body {
        padding: 1rem;
      }

      .container {
        padding: 1.25rem;
      }

      h1 {
        font-size: 1.35rem;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <a class="nav-link" href="./index.html">
      <span>←</span>
      <span>Torna alla Classifica</span>
    </a>

    <h1>
      <span>Test notifiche push</span>
      <span class="pill">Sandbox</span>
    </h1>

    <div class="info-box">
      <p>Abilita le notifiche nell'app principale, poi personalizza titolo, body e azioni prima di inviare il test.</p>
      <p>Le azioni sono utili per percorsi come "accetta" o "ignora"; non tutte le piattaforme le mostrano.</p>
    </div>

    <div class="grid">
      <div class="section">
        <h2>Contenuto</h2>
        <div class="form-group">
          <label for="title">Titolo</label>
          <input type="text" id="title" value="Nuova partita disponibile" />
        </div>
        <div class="form-group">
          <label for="navigate">Navigate URL</label>
          <input type="text" id="navigate" value="/" placeholder="/matchmaking.html" />
        </div>
        <div class="form-group">
          <label for="playerSelect">Seleziona Giocatore</label>
          <select id="playerSelect" onchange="updatePayloadPreview()">
            <option value="">-- Seleziona un giocatore --</option>
            <!-- Options will be populated here -->
          </select>
        </div>
        <div class="form-group">
          <label for="body">Messaggio</label>
          <textarea id="body">Sei stato selezionato per la prossima partita. Confermi la disponibilita?</textarea>
        </div>
        <div class="grid">
          <div class="form-group">
            <label for="dir">Direzione testo</label>
            <select id="dir">
              <option value="">(default)</option>
              <option value="auto">auto</option>
              <option value="ltr">ltr</option>
              <option value="rtl">rtl</option>
            </select>
          </div>
          <div class="form-group">
            <label for="lang">Lingua (es: it-IT)</label>
            <input type="text" id="lang" placeholder="it-IT" />
          </div>
          <div class="form-group">
            <label for="tag">Tag</label>
            <input type="text" id="tag" placeholder="matchmaking" />
          </div>
        </div>
        <div class="grid">
          <div class="form-group">
            <label for="icon">Icon</label>
            <input type="text" id="icon" placeholder="/icons/icon-192.jpg" value="/icons/icon-192.jpg" />
          </div>
          <div class="form-group">
            <label for="badge">Badge</label>
            <input type="text" id="badge" placeholder="/icons/icon-192-maskable.png"
              value="/icons/icon-192-maskable.png" />
          </div>
          <div class="form-group">
            <label for="image">Image</label>
            <input type="text" id="image" placeholder="https://.../image.jpg" />
          </div>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="requireInteraction" checked />
          <label for="requireInteraction" style="margin: 0;">Richiedi interazione (sticky)</label>
        </div>
        <div class="grid">
          <div class="checkbox-group">
            <input type="checkbox" id="renotify" />
            <label for="renotify" style="margin: 0;">Renotify</label>
          </div>
          <div class="checkbox-group">
            <input type="checkbox" id="silent" />
            <label for="silent" style="margin: 0;">Silenziosa</label>
          </div>
          <div class="checkbox-group">
            <input type="checkbox" id="mutable" />
            <label for="mutable" style="margin: 0;">Mutable (invia anche evento push)</label>
          </div>
        </div>
        <div class="grid">
          <div class="form-group">
            <label for="vibrate">Vibrate pattern (comma)</label>
            <input type="text" id="vibrate" placeholder="100,50,100" />
          </div>
          <div class="form-group">
            <label for="timestamp">Timestamp (ms epoch)</label>
            <input type="number" id="timestamp" placeholder="Date.now()" />
          </div>
        </div>
        <div class="form-group">
          <label for="data">Data (JSON qualsiasi)</label>
          <textarea id="data" placeholder='{"foo":"bar"}'></textarea>
        </div>
      </div>

      <div class="section">
        <h2>Azioni</h2>
        <small>Aggiungi fino a 2 azioni; servono ID stabili per gestire i click lato service worker.</small>
        <div class="actions-container" id="actionsContainer">
          <div class="action-item">
            <input type="text" placeholder="ID azione (es: accept)" value="accept" data-field="action" />
            <input type="text" placeholder="Titolo (es: Accetta)" value="Accetta" data-field="title" />
            <input type="text" placeholder="Navigate URL (opzionale)" value="/matchmaking.html" data-field="navigate" />
            <input type="text" placeholder="Icon URL (opzionale)" value="/icons/icon-192.jpg" data-field="icon" />
            <button type="button" onclick="removeAction(this)">✖</button>
          </div>
          <div class="action-item">
            <input type="text" placeholder="ID azione (es: ignore)" value="ignore" data-field="action" />
            <input type="text" placeholder="Titolo (es: Ignora)" value="Ignora" data-field="title" />
            <input type="text" placeholder="Navigate URL (opzionale)" value="/" data-field="navigate" />
            <input type="text" placeholder="Icon URL (opzionale)" value="/icons/icon-192.jpg" data-field="icon" />
            <button type="button" onclick="removeAction(this)">✖</button>
          </div>
        </div>
        <button type="button" class="add-action-btn" onclick="addAction()">Aggiungi azione</button>
      </div>
    </div>

    <div class="grid">
      <div class="section">
        <h2>Invio</h2>
        <button type="button" id="sendBtn" onclick="sendTestNotification()">Invia notifica di test</button>
        <div id="status" class="status"></div>
      </div>

      <div class="section">
        <h2>Payload</h2>
        <small>Preview del JSON inviato all'endpoint.</small>
        <pre id="payloadPreview" class="code-block"></pre>
      </div>
    </div>
  </div>

  <script type="module">
    import { getAllPlayers } from '/src/services/player.service.ts';

    async function fetchPlayers() {
      const players = getAllPlayers();
      const playerSelect = document.getElementById('playerSelect');
      players.forEach(player => {
        const option = document.createElement('option');
        option.value = player.id;
        option.textContent = player.name;
        playerSelect.appendChild(option);
      });
    }

    fetchPlayers(); // Call the function to populate the select

    function updatePayloadPreview() {
      const payload = buildPayload();
      document.getElementById('payloadPreview').textContent = JSON.stringify(payload, null, 2);
    }

    function buildPayload() {
      const title = document.getElementById('title').value;
      const navigate = document.getElementById('navigate').value || '/';
      const body = document.getElementById('body').value;
      const requireInteraction = document.getElementById('requireInteraction').checked;
      const dir = document.getElementById('dir').value;
      const lang = document.getElementById('lang').value;
      const tag = document.getElementById('tag').value;
      const icon = document.getElementById('icon').value;
      const badge = document.getElementById('badge').value;
      const image = document.getElementById('image').value;
      const renotify = document.getElementById('renotify').checked;
      const silent = document.getElementById('silent').checked;
      const mutable = document.getElementById('mutable').checked;
      const vibrateRaw = document.getElementById('vibrate').value;
      const timestampRaw = document.getElementById('timestamp').value;
      const dataRaw = document.getElementById('data').value;

      const actions = [];
      document.querySelectorAll('.action-item').forEach(item => {
        const actionId = item.querySelector('[data-field="action"]').value;
        const actionTitle = item.querySelector('[data-field="title"]').value;
        const actionNavigate = item.querySelector('[data-field="navigate"]')?.value;
        const actionIcon = item.querySelector('[data-field="icon"]')?.value;
        if (actionId && actionTitle) {
          const a = { action: actionId, title: actionTitle };
          if (actionNavigate) a.navigate = actionNavigate;
          if (actionIcon) a.icon = actionIcon;
          actions.push(a);
        }
      });

      const playerId = document.getElementById('playerSelect').value; // Get selected player ID

      // parse vibrate
      let vibrate;
      if (vibrateRaw && typeof vibrateRaw === 'string') {
        const arr = vibrateRaw.split(/[,\s]+/).filter(Boolean).map(n => Number(n)).filter(n => Number.isInteger(n) && n >= 0);
        if (arr.length) vibrate = arr;
      }

      // parse timestamp
      let timestamp = undefined;
      if (timestampRaw) {
        const t = Number(timestampRaw);
        if (Number.isFinite(t) && t >= 0) timestamp = Math.floor(t);
      }

      // parse data JSON if possible; otherwise send as string
      let data;
      if (dataRaw) {
        try { data = JSON.parse(dataRaw); } catch { data = dataRaw; }
      }

      return {
        playerId,
        title,
        navigate,
        body,
        dir: dir || undefined,
        lang: lang || undefined,
        tag: tag || undefined,
        icon: icon || undefined,
        badge: badge || undefined,
        image: image || undefined,
        vibrate,
        timestamp,
        renotify,
        silent,
        requireInteraction,
        data,
        actions: actions.length > 0 ? actions : undefined,
        mutable
      };
    }

    window.addAction = function () {
      const container = document.getElementById('actionsContainer');
      const actionItem = document.createElement('div');
      actionItem.className = 'action-item';
      actionItem.innerHTML = `
        <input type="text" placeholder="ID azione" data-field="action" />
        <input type="text" placeholder="Titolo" data-field="title" />
        <input type="text" placeholder="Navigate URL (opzionale)" data-field="navigate" />
        <input type="text" placeholder="Icon URL (opzionale)" value="/icons/icon-192.jpg" data-field="icon" />
        <button type="button" onclick="removeAction(this)">✖</button>
      `;
      container.appendChild(actionItem);
      updatePayloadPreview();
    };

    window.removeAction = function (btn) {
      btn.closest('.action-item').remove();
      updatePayloadPreview();
    };

    window.sendTestNotification = async function () {
      const sendBtn = document.getElementById('sendBtn');
      const status = document.getElementById('status');

      sendBtn.disabled = true;
      status.className = 'status';
      status.textContent = '⏳ Invio in corso...';
      status.style.display = 'block';

      try {
        const payload = buildPayload();

        const response = await fetch(`${import.meta.env.VITE_API_BASE_URL}/test-notification`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          throw new Error(`${response.statusText}: ${await response.text()}`);
        }

        const result = await response.json();


        status.className = 'status success';
        status.textContent = '✅ ' + result.message;

      } catch (err) {
        status.className = 'status error';
        status.textContent = '❌ Errore: ' + err.message;
      } finally {
        sendBtn.disabled = false;
      }
    };

    // Update preview on any input change
    document.addEventListener('input', updatePayloadPreview);
    document.getElementById('requireInteraction').addEventListener('change', updatePayloadPreview);

    // Initial preview
    updatePayloadPreview();
  </script>
</body>

</html>