const q="_notificationHeader_ppz9o_2",Q="_notificationUserButton_ppz9o_14",X="_active_ppz9o_45",ee="_notificationUserIcon_ppz9o_74",te="_userAvatar_ppz9o_98",ne="_inactive_ppz9o_171",ae="_notificationExpanded_ppz9o_197",oe="_notificationInlineSelect_ppz9o_210",ie="_iosPwaInstallBanner_ppz9o_293",l={notificationHeader:q,notificationUserButton:Q,active:X,notificationUserIcon:ee,userAvatar:te,inactive:ne,notificationExpanded:ae,notificationInlineSelect:oe,iosPwaInstallBanner:ie},D=void 0,re="/api",G="/biliardino-elo/",se=`<span>Installa l'app per sbloccare le notifiche!
  <b>Condividi</b>
  <span style="vertical-align: middle;">
    <svg viewBox="0 0 88.3787841796875 120.0673828125" version="1.1" xmlns="http://www.w3.org/2000/svg"
      class="glyph-box" style="height: 18px; width: 18px">
      <g transform="matrix(1 0 0 1 -12.451206054687418 95.263671875)">
        <path
          d="M 56.6895 -22.4121 C 59.1797 -22.4121 61.2305 -24.4629 61.2305 -26.9043 L 61.2305 -76.0254 L 60.8887 -83.252 L 63.8672 -79.6875 L 70.7031 -72.4121 C 71.4844 -71.5332 72.6074 -71.0938 73.7305 -71.0938 C 75.9766 -71.0938 77.832 -72.7051 77.832 -75 C 77.832 -76.2207 77.3438 -77.0996 76.5137 -77.9297 L 60.1562 -93.7012 C 58.9844 -94.873 57.8613 -95.2637 56.6895 -95.2637 C 55.4688 -95.2637 54.3945 -94.873 53.2227 -93.7012 L 36.8164 -77.9297 C 35.9863 -77.0996 35.498 -76.2207 35.498 -75 C 35.498 -72.7051 37.3047 -71.0938 39.5508 -71.0938 C 40.6738 -71.0938 41.8457 -71.5332 42.627 -72.4121 L 49.4629 -79.6875 L 52.4902 -83.3008 L 52.0996 -76.0254 L 52.0996 -26.9043 C 52.0996 -24.4629 54.1504 -22.4121 56.6895 -22.4121 Z M 28.5156 16.6016 L 84.7656 16.6016 C 95.3613 16.6016 100.83 11.1328 100.83 0.683594 L 100.83 -47.3145 C 100.83 -57.7637 95.3613 -63.2324 84.7656 -63.2324 L 71.582 -63.2324 L 71.582 -53.5156 L 84.1309 -53.5156 C 88.5742 -53.5156 91.1133 -51.1719 91.1133 -46.4844 L 91.1133 -0.195312 C 91.1133 4.49219 88.5742 6.83594 84.1309 6.83594 L 29.1504 6.83594 C 24.6582 6.83594 22.168 4.49219 22.168 -0.195312 L 22.168 -46.4844 C 22.168 -51.1719 24.6582 -53.5156 29.1504 -53.5156 L 41.8457 -53.5156 L 41.8457 -63.2324 L 28.5156 -63.2324 C 17.9688 -63.2324 12.4512 -57.8125 12.4512 -47.3145 L 12.4512 0.683594 C 12.4512 11.1328 17.9688 16.6016 28.5156 16.6016 Z">
        </path>
      </g>
    </svg>
  </span>
  e poi seleziona
  <b>Aggiungi alla schermata Home</b>
  <span style="vertical-align: middle;">
    <svg xmlns="http://www.w3.org/2000/svg" style="height: 17.0405px; width: 17.0405px" direction="ltr" version="1.1">
      <g fill-rule="nonzero" transform="scale(0.35,-0.35) translate(0,-44.236328125)">
        <path fill="black" stroke="black" fill-opacity="1.0" stroke-width="2.5"
          d="     M 11.0,3.330078125     L 37.5546875,3.330078125     C 41.142578125,3.330078125 43.076171875,5.28515625 43.076171875,8.8515625     L 43.076171875,35.384765625     C 43.076171875,38.951171875 41.142578125,40.90625 37.5546875,40.90625     L 11.0,40.90625     C 7.390625,40.90625 5.478515625,38.994140625 5.478515625,35.384765625     L 5.478515625,8.8515625     C 5.478515625,5.2421875 7.390625,3.330078125 11.0,3.330078125     Z     M 11.04296875,4.3828125     C 8.078125,4.3828125 6.53125,5.9296875 6.53125,8.89453125     L 6.53125,35.341796875     C 6.53125,38.328125 8.078125,39.853515625 11.04296875,39.853515625     L 37.490234375,39.853515625     C 40.369140625,39.853515625 42.0234375,38.328125 42.0234375,35.341796875     L 42.0234375,8.89453125     C 42.0234375,5.9296875 40.369140625,4.3828125 37.490234375,4.3828125     Z     M 24.234375,11.9453125     C 24.578125,11.9453125 24.8359375,12.181640625 24.8359375,12.4609375     L 24.8359375,21.591796875     L 33.923828125,21.591796875     C 34.203125,21.591796875 34.4609375,21.87109375 34.4609375,22.12890625     C 34.4609375,22.4296875 34.224609375,22.708984375 33.923828125,22.708984375     L 24.8359375,22.708984375     L 24.8359375,31.796875     C 24.8359375,32.09765625 24.578125,32.333984375 24.234375,32.333984375     C 23.955078125,32.333984375 23.71875,32.09765625 23.71875,31.796875     L 23.71875,22.708984375     L 14.630859375,22.708984375     C 14.30859375,22.708984375 14.072265625,22.4296875 14.072265625,22.12890625     C 14.072265625,21.87109375 14.3515625,21.591796875 14.630859375,21.591796875     L 23.71875,21.591796875     L 23.71875,12.4609375     C 23.71875,12.181640625 23.955078125,11.9453125 24.234375,11.9453125     Z " />
      </g>
    </svg></span>.</span>
</span>`,ce=["Mario Rossi","Luigi Verdi","Anna Bianchi","Paolo Neri","Giulia Russo","Marco Ferrari","Sofia Romano","Alessandro Marino","Francesca Greco","Matteo Conti","Chiara Ricci","Andrea Bruno","Elena Colombo","Davide Rizzo","Sara Barbieri","Simone Costa","Laura Fontana","Lorenzo Moretti","Valentina Serra","Francesco Leone","Martina Giordano","Gabriele Marchetti","Federica De Luca","Luca Mancini","Alessia Vitale","Nicola Lombardi","Giorgia Santoro","Stefano Caruso","Elisa Mariani","Roberto Rinaldi","Claudia Longo","Daniele Ferraro","Beatrice Gallo","Tommaso Martini","Silvia Messina"];let g=ce.map((e,t)=>{const n=1e3+Math.floor(Math.random()*400),o=Math.round((.3+Math.random()*.4)*100)/100;return{id:t+1,name:e,elo:n,startElo:n,defence:o,matches:0,bestElo:n,goalsAgainst:0,goalsFor:0,matchesAsAttacker:0,matchesAsDefender:0,matchesDelta:[],wins:0,rank:-1}});const A=[{id:1,teamA:{defence:1,attack:2},teamB:{defence:3,attack:4},score:[10,8],createdAt:Date.now()-1e3*60*60*24*7,deltaELO:[-1,-1],expectedScore:[-1,-1],teamELO:[-1,-1],teamAELO:[-1,-1],teamBELO:[-1,-1]},{id:2,teamA:{defence:1,attack:3},teamB:{defence:2,attack:4},score:[10,5],createdAt:Date.now()-1e3*60*60*24*5,deltaELO:[-1,-1],expectedScore:[-1,-1],teamELO:[-1,-1],teamAELO:[-1,-1],teamBELO:[-1,-1]}];let I=null;async function u(e=100){return new Promise(t=>setTimeout(t,e))}async function B(){console.log("[MOCK] Updating players cache hash"),await u(50)}async function H(){console.log("[MOCK] Updating matches cache hash"),await u(50)}async function le(){return console.log("[MOCK] Fetching players:",g.length),await u(),JSON.parse(JSON.stringify(g))}async function de(){return console.log("[MOCK] Fetching matches:",A.length),await u(),JSON.parse(JSON.stringify(A))}async function ue(e){console.log("[MOCK] Saving match:",e.id),await u();const t=A.findIndex(o=>o.id===e.id),n={...e,deltaELO:[-1,-1],expectedScore:[-1,-1],teamELO:[-1,-1],teamAELO:[-1,-1],teamBELO:[-1,-1]};t>=0?A[t]=n:A.push(n),await H()}function fe(e){return{id:e.id,teamA:e.teamA,teamB:e.teamB,score:e.score,createdAt:e.createdAt,deltaELO:[-1,-1],expectedScore:[-1,-1],teamELO:[-1,-1],teamAELO:[-1,-1],teamBELO:[-1,-1]}}async function pe(e){console.log("[MOCK] Saving running match"),await u(),I=JSON.parse(JSON.stringify(e))}async function ge(){return console.log("[MOCK] Fetching running match"),await u(),I?JSON.parse(JSON.stringify(I)):null}async function me(){console.log("[MOCK] Clearing running match"),await u(),I=null}async function he(e){console.log("[MOCK] Saving player:",e.id,e.name),await u();const t=g.findIndex(n=>n.id===e.id);t>=0?g[t]=JSON.parse(JSON.stringify(e)):g.push(JSON.parse(JSON.stringify(e))),await B()}async function Me(e){console.log("[MOCK] Deleting player:",e),await u(),g=g.filter(t=>t.id!==e),await B()}const we=Object.freeze(Object.defineProperty({__proto__:null,clearRunningMatch:me,deletePlayer:Me,fetchMatches:de,fetchPlayers:le,fetchRunningMatch:ge,parseMatchDTO:fe,saveMatch:ue,savePlayer:he,saveRunningMatch:pe,updateMatchesHash:H,updatePlayersHash:B},Symbol.toStringTag,{value:"Module"})),h=we,ve=h.fetchPlayers,Ae=h.fetchMatches,Ze=h.saveMatch,Ce=h.parseMatchDTO,Ge=h.saveRunningMatch,He=h.fetchRunningMatch,$e=h.clearRunningMatch;console.log("[Repository] Using MOCK data source");const k=new Map;let O=[];await Ee();function w(e){return k.get(e)}function Fe(e){for(const[,t]of k)if(t.name.includes(e))return t}function ye(){return O}function y(e,t,n,o,r,i,s,c){const a=w(e);a&&(a.elo+=r,a.bestElo=Math.max(a.bestElo??a.elo,a.elo),a.matches++,a.wins+=r>0?1:0,a.goalsFor+=s,a.goalsAgainst+=c,a.matchesAsDefender+=i?1:0,a.matchesAsAttacker+=i?0:1,e>t&&(a.teammatesMatchCount||(a.teammatesDelta=new Map,a.teammatesMatchCount=new Map),a.teammatesDelta.set(t,(a.teammatesDelta.get(t)??0)+r),a.teammatesMatchCount.set(t,(a.teammatesMatchCount.get(t)??0)+1)),e>n&&(a.opponentsMatchCount??=new Map,a.opponentsMatchCount.set(n,(a.opponentsMatchCount.get(n)??0)+1)),e>o&&(a.opponentsMatchCount??=new Map,a.opponentsMatchCount.set(o,(a.opponentsMatchCount.get(o)??0)+1)),a.matchesDelta.push(r))}async function Ee(){O=await ve();for(const e of O)k.set(e.id,e)}function Ie(){return localStorage.getItem("biliardino_player_name")}function Le(){Se()}const L=new Map;let f=0,p=null;function be(e){const t="=".repeat((4-e.length%4)%4),n=(e+t).replace(/-/g,"+").replace(/_/g,"/");return new Uint8Array(atob(n).split("").map(o=>o.charCodeAt(0)))}function Se(){const e=Oe();document.body.appendChild(e),b()}function Oe(){const e=document.createElement("div");e.className=l.notificationHeader;const t=Be();return e.appendChild(t),t.addEventListener("click",n=>{n.preventDefault(),xe(t),Ne(),Notification.permission==="default"?Notification.requestPermission().then(()=>{b()}):ke(t)}),e}function Be(){const e=document.createElement("button");e.id="notification-user-button",e.className=l.notificationUserButton,e.type="button",e.setAttribute("aria-label","Impostazioni Notifiche"),e.setAttribute("data-tooltip","Notifiche");const t=document.createElement("select");t.className=l.notificationInlineSelect,t.setAttribute("aria-label","Seleziona utente"),t.setAttribute("id","select-notification-player");const n=[...ye().toSorted((a,d)=>a.name.localeCompare(d.name))],o=localStorage.getItem("biliardino_player_id"),r=document.createElement("option");r.value="",r.textContent="Seleziona utente...",r.disabled=!0,o||(r.selected=!0),t.appendChild(r),n.forEach(a=>{const d=document.createElement("option");d.value=String(a.id),d.textContent=a.name,o&&String(a.id)===o&&(d.selected=!0),t.appendChild(d)}),t.addEventListener("change",async()=>{const a=Number(t.value);if(!a){v(e);return}const d=n.find(M=>M.id===a)?.name||"";try{await Pe(a,d),v(e),b()}catch(M){console.error("Errore registrazione",M),v(e)}}),t.addEventListener("click",a=>{a.stopPropagation()}),t.addEventListener("blur",()=>{const a=window.setTimeout(()=>{v(e),L.delete(e)},200);L.set(e,a)});const i=document.createElement("img");i.className=l.userAvatar,i.alt="Avatar Utente",i.setAttribute("data-player-avatar","true");const s="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA0OCA0OCI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJncmFkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjAlIiB5MT0iMCUiIHgyPSIwJSIgeTI9IjEwMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNlMGUwZTA7c3RvcC1vcGFjaXR5OjEiIC8+PHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojZjVmNWY1O3N0b3Atb3BhY2l0eToxIiAvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgZmlsbD0idXJsKCNncmFkKSIvPjxjaXJjbGUgY3g9IjI0IiBjeT0iMTUiIHI9IjciIGZpbGw9IiM3OTdhYjEiLz48cGF0aCBkPSJNIDEwIDMwIEMgMTAgMjQgMTYgMjAgMjQgMjAgQyAzMiAyMCAzOCAyNCAzOCAzMCBDIDM4IDM4IDMyIDQyIDI0IDQyIEMgMTYgNDIgMTAgMzggMTAgMzAiIGZpbGw9IiM3OTdhYjEiLz48L3N2Zz4=";i.addEventListener("error",()=>{i.src=s});const c=document.createElement("span");return c.className=l.notificationUserIcon,c.setAttribute("aria-hidden","true"),c.innerHTML=`
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
      <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
    </svg>
  `,e.appendChild(i),e.appendChild(c),e.appendChild(t),e}function ke(e){const t=e.querySelector(`.${l.notificationInlineSelect}`);if(!t)return;if(e.classList.contains(l.notificationExpanded)){v(e);return}e.classList.add(l.notificationExpanded),requestAnimationFrame(()=>{t.focus();try{t.click()}catch{}})}function v(e){e.classList.remove(l.notificationExpanded);const t=L.get(e);t&&(window.clearTimeout(t),L.delete(e))}async function b(){const e=document.getElementById("notification-user-button");if(!e)return;const t=e.querySelector(`.${l.userAvatar}`),n=e.querySelector(`.${l.notificationUserIcon}`),o=Notification.permission==="granted";let r=o?"Seleziona Giocatore":"Abilita notifiche";const i=localStorage.getItem("biliardino_player_id");n&&(n.innerHTML=`
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
      </svg>
    `),o?i&&(t&&(t.src=`${G}avatars/${i}.webp`),r+=i?` - Utente: ${Ie()}`:" - Nessun utente selezionato"):n&&(n.innerHTML=`
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
        <line x1="1" y1="1" x2="23" y2="23"></line>
      </svg>
    `),o&&i&&(localStorage.getItem("biliardino_subscription")?(e.classList.add(l.active),e.classList.remove(l.inactive),r="Notifiche attive"):(e.classList.add(l.inactive),e.classList.remove(l.active),r="Errori nella subscription, riprova")),e.setAttribute("data-tooltip",r)}async function Pe(e,t){if(!("serviceWorker"in navigator)){const n="Service workers non supportati su questo browser";throw alert(n),new Error(n)}localStorage.setItem("biliardino_player_id",String(e)),localStorage.setItem("biliardino_player_name",t);try{const n=await navigator.serviceWorker.ready,r=await n.pushManager.getSubscription()||await n.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:be(D)});console.log("VAPID_PUBLIC_KEY:",D);const i=new AbortController,s=setTimeout(()=>i.abort(),1e4);try{const c=await fetch(`${re}/subscription`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subscription:r,playerId:e,playerName:t}),signal:i.signal});if(clearTimeout(s),!c.ok){const d=(await c.json().catch(()=>({}))).error||`Errore API: ${c.status} ${c.statusText}`;throw alert(`Errore API: ${d}`),new Error(d)}localStorage.setItem("biliardino_subscription",JSON.stringify(r)),console.log("Subscription salvata con successo")}catch(c){clearTimeout(s);const a=c instanceof Error?c.message:"Errore sconosciuto";throw alert(`Errore di rete: ${a}`),c}}catch(n){localStorage.removeItem("biliardino_subscription");const o=n instanceof Error?n.message:"Errore sconosciuto";throw n instanceof Error&&n.message.includes("Service workers")||alert("Errore durante la registrazione delle notifiche: "+o),console.error("Errore registrazione notifiche:",n),n}finally{b()}}function xe(e){if(f++,p!==null&&window.clearTimeout(p),p=window.setTimeout(()=>{f=0,p=null},3e3),f>=3&&f<6){const t=6-f;e.setAttribute("data-tooltip",`${t} click rimanenti...`)}f===6&&(f=0,p!==null&&(window.clearTimeout(p),p=null),confirm(`ðŸŽ‰ Easter egg sbloccato!

Vuoi accedere alla pagina di test delle notifiche?`)&&(window.location.href=`${G}test-notifications.html`))}function Ne(){const e=/iphone|ipad|ipod/i.test(navigator.userAgent),t=window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone===!0;if(e&&!t){document.getElementById("ios-pwa-install-banner")?.remove();const n=document.createElement("div");n.id="ios-pwa-install-banner",n.className=l.iosPwaInstallBanner,n.innerHTML=se,document.body.appendChild(n)}}const R="/biliardino-elo/";"serviceWorker"in navigator&&navigator.serviceWorker.register(`${R}sw.js`,{scope:R}).then(()=>{console.info("Service worker registered, initializing notifications..."),Le()}).catch(e=>{console.warn(`Error registering service worker:
${e}.`)});const _e=40,j=40,Te=1;function ze(e){const t=w(e.teamA.defence),n=w(e.teamA.attack),o=w(e.teamB.defence),r=w(e.teamB.attack);if(!t||!n||!o||!r)throw new Error("One or more players not found for match Elo calculation.");const[i,s]=e.score,c=E(t,!0),a=E(n,!1),d=E(o,!0),M=E(r,!1),P=(c+a)/2,x=(d+M)/2,C=De(P,x),S=1-C,N=Re(i,s),_=i>s?C:S,F=_>.5?-1:1,T=1+3*Math.pow(Math.abs(.5-_),1.5)*F,z=i>s?1:i===s?.5:0,J=1-z,K=Z(t,n),V=Z(o,r),W=K*N*(z-C)*T,Y=V*N*(J-S)*T;e.expectedScore[0]=C,e.expectedScore[1]=S,Math.max(i,s)<8?(e.deltaELO[0]=0,e.deltaELO[1]=0):(e.deltaELO[0]=W,e.deltaELO[1]=Y),e.teamELO[0]=P,e.teamELO[1]=x,e.teamAELO[0]=c,e.teamAELO[1]=a,e.teamBELO[0]=d,e.teamBELO[1]=M}function E(e,t){return e.elo-(t?1-e.defence:e.defence)*100}function U(e){const t=Math.max(0,(1-e/Te)*(_e-j));return j+t}function Z(e,t){return(U(e.matches)+U(t.matches))/2}function De(e,t){return 1/(1+Math.pow(10,(t-e)/400))}function Re(e,t){return 1+Math.abs(e-t)/8*.5}function $(e){ze(e);const t=e.teamA,n=e.teamB,[o,r]=e.deltaELO,[i,s]=e.score;y(t.defence,t.attack,n.defence,n.attack,o,!0,i,s),y(t.attack,t.defence,n.defence,n.attack,o,!1,i,s),y(n.defence,n.attack,t.defence,t.attack,r,!0,s,i),y(n.attack,n.defence,t.defence,t.attack,r,!1,s,i)}let m=[];await je();Ue();async function je(){m=await Ae(),m.sort((e,t)=>e.createdAt-t.createdAt)}function Je(){return m}function Ke(e,t,n){const o=Math.max(...m.map(c=>c.id)),i={id:Number.isFinite(o)?o+1:1,teamA:e,teamB:t,score:n,createdAt:Date.now()},s=Ce(i);return m.push(s),$(s),i}function Ve(e,t,n,o){const r=m.find(i=>i.id===e);if(!r)throw new Error("Match to edit not found.");return r.teamA=t,r.teamB=n,r.score=o,{id:e,teamA:t,teamB:n,score:o,createdAt:r.createdAt}}function Ue(){for(const e of m)$(e)}export{G as B,Je as a,w as b,E as c,Ke as d,Ve as e,He as f,ye as g,$e as h,Fe as i,Ge as j,Ze as s};
