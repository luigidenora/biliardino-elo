import"./modulepreload-polyfill-B5Qt9EMX.js";import{w as $}from"./auth.util-DTc4Y7u9.js";import{b as I,c as g,a as j,f as O,h as L,g as x,i as Z,j as H,B as F,d as W,s as q}from"./match.service-8YMje7wm.js";import{g as z}from"./get-display-elo.util-CFHiuv7v.js";import"./firebase-BkA1I5aN.js";const R={monday:["Francesco Molinari","Davide Colucci","Domenico Pace","Michele Lillo","Michele Sette","Salvatore Defino","Michele Porcu","Dario Spinosa","Filippo Addabbo","Marco De Luca","Nicola Sergio","Matteo Attanasio","Gianluca De Vincenzo","Giuseppe Larato","Francesco Giustino"],tuesday:["Francesco Molinari","Davide Colucci","Michele Lillo","Michele Sette","Michele Porcu","Pietro Colonna","Andrea Greco","Andrea Fraccalvieri","Alfredo Sette","Filippo Addabbo","Giuseppe Latrofa","Loris Bevilacqua","Marco De Luca","Nicola Sergio","Gianluca De Vincenzo","Ilenia Taccogna"],wednesday:["Francesco Molinari","Davide Colucci","Domenico Pace","Michele Lillo","Michele Sette","Michele Porcu","Davide Silletti","Leonardo Galluzzi","Filippo Addabbo","Marco De Luca","Salvatore Defino","Nicola Sergio","Matteo Attanasio","Gianluca De Vincenzo","Dario Spinosa","Andrea Difonzo","Giuseppe Larato","Francesco Giustino"],thursday:["Francesco Molinari","Davide Colucci","Michele Lillo","Michele Sette","Michele Porcu","Pietro Colonna","Davide Silletti","Andrea Greco","Andrea Fraccalvieri","Alfredo Sette","Andrea Gargaro","Amedeo D'Amelio","Filippo Addabbo","Giuseppe Latrofa","Loris Bevilacqua","Marco De Luca","Nicola Sergio","Gianluca De Vincenzo","Ilenia Taccogna"],friday:["Francesco Molinari","Davide Colucci","Michele Lillo","Michele Sette","Michele Porcu","Andrea Gargaro","Dario Spinosa","Filippo Addabbo","Luigi Denora","Marco De Luca","Salvatore Defino","Nicola Sergio","Leonardo Galluzzi","Gianluca De Vincenzo","Andrea Difonzo"]},S={matchBalanceWeight:.3,teamBalanceWeight:.2,priorityWeight:.15,diversityWeight:.35,randomness:.1};function U(l,t){if(l.length<4)return null;const e=l.map(d=>I(d)),a=t.map(d=>I(d));if(e.includes(void 0))throw new Error("Some player IDs are invalid");const n=Q(e),c=K(e),o=X(e,l),r=[],s=[];return ee(j(),e,r,s),k(n,c,o,r,s,a)}function k(l,t,e,a,n,c){const o=a.length,r=n.length,s={teamA:{defence:a[0],attack:n[0]},teamB:{defence:a[0],attack:n[0]}};let d=-1/0;for(let u=0;u<o-1;u++){const m=a[u];for(let p=0;p<r-1;p++){const y=n[p];if(y!==m)for(let h=u+1;h<o;h++){const f=a[h];if(f!==y)for(let b=p+1;b<r;b++){const v=n[b];v===m||v===f||Y(m,y,f,v,c)&&(d=J(m,y,f,v,l,t,e,d,s))}}}}return d===-1/0?null:s}function Y(l,t,e,a,n){const c=new Set([l,t,e,a]);for(const o of n)if(!c.has(o))return!1;return!0}function J(l,t,e,a,n,c,o,r,s){const d=(g(l,!0)+g(t,!1))/2,u=(g(e,!0)+g(a,!1))/2,y=(1-Math.abs(d-u)/n)*S.matchBalanceWeight,h=Math.abs(g(l,!0)-g(t,!1)),f=Math.abs(g(e,!0)-g(a,!1)),b=Math.max(h,f),C=(1-Math.min(1,b/n))*S.teamBalanceWeight,B=(1-(l.matches+t.matches+e.matches+a.matches)/c)*S.priorityWeight,N=w(l,t,e,a),E=V(l,t,e,a),T=(1-(N/o.teammate+E/o.opponent)/2)*S.diversityWeight,D=_(T,y,B,C);return D>r&&(s.teamA.defence=l,s.teamA.attack=t,s.teamB.defence=e,s.teamB.attack=a,r=D),r}function Q(l){let t=-1/0,e=1/0,a=-1/0,n=1/0;for(const o of l)o.elo>t?(a=t,t=o.elo):o.elo>a&&(a=o.elo),o.elo<e?(n=e,e=o.elo):o.elo<n&&(n=o.elo);const c=(t+a-e-n)/2;return Math.max(c,1)}function K(l){const t=[...l].sort((a,n)=>n.matches-a.matches),e=t[0].matches+t[1].matches+t[2].matches+t[3].matches;return Math.max(e,1)}function X(l,t){const e=new Set(t),a=new Array(4).fill(0);let n=0,c=0;for(const o of l)o.teammatesMatchCount?.forEach((r,s)=>{e.has(s)&&(r>n?(c=n,n=r):r>c&&(c=r))}),o.opponentsMatchCount?.forEach((r,s)=>{if(!(r<=a[3]||!e.has(s))){for(let d=0;d<4;d++)if(r>a[d]){for(let u=3;u>d;u--)a[u]=a[u-1];a[d]=r}}});return{teammate:Math.max(n+c,1),opponent:Math.max(a[0]+a[1]+a[2]+a[3],1)}}function w(l,t,e,a){const n=l.id>t.id?l:t,c=l.id>t.id?t:l,o=n.teammatesMatchCount?.get(c.id)??0,r=e.id>a.id?e:a,s=e.id>a.id?a:e,d=r.teammatesMatchCount?.get(s.id)??0;return o+d}function V(l,t,e,a){const n=l.id>e.id?l:e,c=l.id>e.id?e:l,o=n.opponentsMatchCount?.get(c.id)??0,r=l.id>a.id?l:a,s=l.id>a.id?a:l,d=r.opponentsMatchCount?.get(s.id)??0,u=t.id>e.id?t:e,m=t.id>e.id?e:t,p=u.opponentsMatchCount?.get(m.id)??0,y=t.id>a.id?t:a,h=t.id>a.id?a:t,f=y.opponentsMatchCount?.get(h.id)??0;return o+d+p+f}function _(l,t,e,a){const n=Math.random()*S.randomness;return l+t+e+a+n}function ee(l,t,e,a){const n=new Map;for(const o of t)n.set(o.id,{matches:0,def:0});for(const o of l){const r=o.teamA,s=o.teamB;c(r.defence,!0),c(r.attack,!1),c(s.defence,!0),c(s.attack,!1)}for(const[o,r]of n){const s=I(o),d=s.defence*10,u=r.matches-r.def,m=10-d;r.def<d&&e.push(s),u<m&&a.push(s)}function c(o,r){const s=n.get(o);s&&(s.matches<9?(s.matches++,s.def+=r?1:0):(s.matches=0,s.def=0))}}class i{static playerStates=new Map;static currentMatch=null;static async init(){i.renderPlayersList(),i.setupEventListeners(),i.renderDisclaimer(),await i.restoreSavedMatch(),i.updateUI()}static async restoreSavedMatch(){try{const t=await O();if(!t)return;const e=i.mapStoredMatchToProposal(t);if(!e){await L();return}i.currentMatch=e,i.renderMatches([e])}catch(t){console.error("Failed to restore generated match",t)}}static mapStoredMatchToProposal(t){const e=I(t.teamA.defence),a=I(t.teamA.attack),n=I(t.teamB.defence),c=I(t.teamB.attack);return!e||!a||!n||!c?null:{teamA:{defence:e,attack:a},teamB:{defence:n,attack:c}}}static renderPlayersList(){const t=document.getElementById("players-list"),a=x().toSorted((m,p)=>m.name.localeCompare(p.name)),c=getComputedStyle(t).getPropertyValue("grid-template-columns").split(/\s+/).filter(Boolean).length,o=[];if(c>1){const m=Math.ceil(a.length/c);for(let p=0;p<m;p++)for(let y=0;y<c;y++){const h=y*m+p;h<a.length&&o.push(a[h])}}else o.push(...a);const s=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"][new Date().getDay()],d=R[s],u=document.createDocumentFragment();o.forEach(m=>{let p=0;Array.isArray(d)&&d.includes(m.name)&&(p=1),i.playerStates.set(m.name,p);const h=document.createElement("label");h.className="player-checkbox",h.dataset.playerName=m.name;const f=document.createElement("input");f.type="checkbox",f.value=m.name,f.dataset.playerName=m.name,p===1&&(f.checked=!0);const b=document.createElement("span");b.className="player-info";const v=document.createElement("span");v.className="player-name",v.textContent=m.name;const C=document.createElement("span");C.className="player-elo",C.textContent=`${z(m)}`,b.appendChild(v),b.appendChild(C),h.appendChild(f),h.appendChild(b),f.addEventListener("click",M=>{const A=i.playerStates.get(m.name)||0;A===0?(i.playerStates.set(m.name,1),h.classList.remove("priority")):A===1?(M.preventDefault(),f.checked=!0,i.playerStates.set(m.name,2),h.classList.add("priority")):(i.playerStates.set(m.name,0),h.classList.remove("priority")),i.updateUI()}),u.appendChild(h)}),t.appendChild(u)}static renderDisclaimer(){const t=document.getElementById("matches-container"),e=document.createElement("div");e.className="match-disclaimer-fixed",e.innerHTML=`
      <div class="disclaimer-icon">‚ö†Ô∏è</div>
      <div class="disclaimer-content">
        <strong>Promemoria importante</strong>
        <p>Il biliardino non √® scontato: solo in pausa e con rispetto, per evitare sanzioni.</p>
      </div>
    `,t.insertBefore(e,t.firstChild);const a=document.createElement("div");a.className="match-rules-panel",a.innerHTML=`
      <div class="rules-icon">üìò</div>
      <div class="rules-content">
        <strong>Regolamento</strong>
        <ul>
          <li>Si vince a <b>8</b> (non ci sono supplementari)</li>
          <li>Si cambia campo dopo <b>7 goal totali</b></li>
          <li>Il goal √® valido solo se ci sono stati almeno due tocchi <b>volontari</b> da stecche diverse</li>
          <li>Non valgono schizzo e rullata</li>
          <li>Se la palla non pu√≤ essere colpita e non √® tra difensore e portiere, si riparte da calcio d'inizio</li>
          <li>I ruoli devono essere rispettati e non posso essere cambiati.</li>
        </ul>
      </div>
    `,e.after(a)}static setupEventListeners(){const t=document.getElementById("select-all-btn"),e=document.getElementById("deselect-all-btn"),a=document.getElementById("generate-match-btn"),n=document.getElementById("delete-match-btn"),c=document.getElementById("matches-container");if(!t||!e||!a||!c||!n){console.error("Missing required DOM elements:",{selectAllButton:!!t,deselectAllButton:!!e,generateButton:!!a,deleteMatchButton:!!n,matchesContainer:!!c});return}t.addEventListener("click",()=>i.selectAllPlayers()),e.addEventListener("click",()=>i.deselectAllPlayers()),a.addEventListener("click",()=>i.generateMatches()),n.addEventListener("click",()=>i.deleteGeneratedMatch()),c.addEventListener("submit",o=>{o.target.classList.contains("match-form")&&(o.preventDefault(),i.saveMatch(o.target))})}static selectAllPlayers(){const t=x(),e=document.getElementById("players-list");t.forEach(a=>{i.playerStates.set(a.name,1);const n=e.querySelector(`label[data-player-name="${a.name}"]`),c=n?.querySelector('input[type="checkbox"]');c&&(c.checked=!0,c.indeterminate=!1,n.classList.remove("priority"))}),i.updateUI()}static deselectAllPlayers(){const t=x(),e=document.getElementById("players-list");t.forEach(a=>{i.playerStates.set(a.name,0);const n=e.querySelector(`label[data-player-name="${a.name}"]`),c=n?.querySelector('input[type="checkbox"]');c&&(c.checked=!1,c.indeterminate=!1,n.classList.remove("priority"))}),i.updateUI()}static updateUI(){const t=Array.from(i.playerStates.values()).filter(s=>s===1).length,e=Array.from(i.playerStates.values()).filter(s=>s===2).length,a=t+e,n=document.getElementById("selected-count"),c=document.getElementById("generate-match-btn"),o=document.getElementById("delete-match-btn");n&&(n.textContent=`${a} selezionati`);const r=a>=4;c.disabled=!r,o&&(o.disabled=!i.currentMatch)}static async generateMatches(){const t=[],e=[];if(i.playerStates.forEach((n,c)=>{const o=Z(c);o&&(n===1?t.push(o.id):n===2&&(e.push(o.id),t.push(o.id)))}),t.length<4){alert("Seleziona almeno 4 giocatori per generare una partita.");return}const a=U(t,e);if(!a){alert("Impossibile generare partite con i giocatori selezionati.");return}i.currentMatch=a,i.renderMatches([a]),i.updateUI(),await i.persistCurrentMatch()}static async persistCurrentMatch(){if(!i.currentMatch)return;const t=i.currentMatch,e={teamA:{defence:t.teamA.defence.id,attack:t.teamA.attack.id},teamB:{defence:t.teamB.defence.id,attack:t.teamB.attack.id}};try{await H(e)}catch(a){console.error("Failed to persist generated match",a)}}static renderMatches(t){const e=document.getElementById("matches-container"),a=e.querySelector(".match-disclaimer-fixed"),n=e.querySelector(".match-rules-panel"),c=e.querySelector(".match-actions"),o=e.querySelector(".empty-state");if(e.innerHTML="",a&&e.appendChild(a),n&&e.appendChild(n),c&&e.appendChild(c),t.length===0){const s=o?.cloneNode(!0)??Object.assign(document.createElement("p"),{className:"empty-state",textContent:'Seleziona almeno 4 giocatori e clicca su "Genera Partita"'});e.appendChild(s);return}const r=document.createDocumentFragment();t.forEach(s=>{const d=i.createMatchCard(s);r.appendChild(d)}),e.appendChild(r)}static createMatchCard(t){const e=document.createElement("div");e.className="match-content";const a=(g(t.teamA.defence,!0)+g(t.teamA.attack,!1))/2,n=(g(t.teamB.defence,!0)+g(t.teamB.attack,!1))/2,c=document.createElement("div");c.className="teams-container";const o=1/(1+Math.pow(10,(n-a)/400)),r=1-o,s=t.teamA.defence,d=t.teamA.attack,u=t.teamB.defence,m=t.teamB.attack,p=i.createTeamCard("A",s,"defence",d,"attack",a,o);c.appendChild(p);const y=document.createElement("div");y.className="center-section";const h=document.createElement("div");h.className="vs-text",h.textContent="VS",y.appendChild(h);const f=i.createScoreInputs();f.querySelectorAll(".score-input").forEach(T=>{T.addEventListener("blur",D=>{const G=D.target;Number.parseInt(G.value)>8&&(G.value="8")})}),y.appendChild(f);const v=document.createElement("div");v.className="probabilities-container";const C=o*100,M=r*100,A=C>50?"probability-high":"probability-low",B=M>50?"probability-high":"probability-low";v.innerHTML=`
      <div class="probability-item ${A}">${C.toFixed(1)}%</div>
      <div class="probability-item ${B}">${M.toFixed(1)}%</div>
    `,y.appendChild(v),c.appendChild(y);const N=i.createTeamCard("B",u,"defence",m,"attack",n,r);c.appendChild(N),e.appendChild(c);const E=document.createElement("button");E.type="submit",E.className="save-match-button",E.textContent="Salva Partita";const P=document.createElement("form");return P.className="match-form",P.appendChild(e),P.appendChild(E),P}static createTeamCard(t,e,a,n,c,o,r){const s=document.createElement("div");s.className="team-card",s.dataset.team=t;const d=Math.round(e.defence*100),u=100-d,m=Math.round(n.defence*100),p=100-m,y="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA0OCA0OCI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJncmFkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjAlIiB5MT0iMCUiIHgyPSIwJSIgeTI9IjEwMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNlMGUwZTA7c3RvcC1vcGFjaXR5OjEiIC8+PHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojZjVmNWY1O3N0b3Atb3BhY2l0eToxIiAvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgZmlsbD0idXJsKCNncmFkKSIvPjxjaXJjbGUgY3g9IjI0IiBjeT0iMTUiIHI9IjciIGZpbGw9IiM3OTdhYjEiLz48cGF0aCBkPSJNIDEwIDMwIEMgMTAgMjQgMTYgMjAgMjQgMjAgQyAzMiAyMCAzOCAyNCAzOCAzMCBDIDM4IDM4IDMyIDQyIDI0IDQyIEMgMTYgNDIgMTAgMzggMTAgMzAiIGZpbGw9IiM3OTdhYjEiLz48L3N2Zz4=",h=a==="defence"?"üõ°Ô∏è":"‚öîÔ∏è",f=a==="defence"?"badge-def":"badge-att",b=a==="defence"?`DIF ${d}%`:`ATT ${u}%`,v=c==="attack"?"‚öîÔ∏è":"üõ°Ô∏è",C=c==="attack"?"badge-att":"badge-def",M=c==="attack"?`ATT ${p}%`:`DIF ${m}%`;return s.innerHTML=`
      <div class="team-title">
        <span class="team-name">Team ${t}</span>
        <span class="team-elo-value">${o.toFixed(0)}</span>
      </div>
      <div class="team-players">
        <div class="player-item">
          <div class="match-player-grid">
            <div class="match-player-avatar">
              <img 
                src="${F}avatars/${e.id}.webp" 
                alt="${e.name}"
                class="match-avatar-img"
                onerror="this.src='${y}'"
              />
            </div>
            <div class="match-player-name"><span class="player-name">${h} ${e.name}</span></div>
            <div class="match-player-meta">
              <span class="role-badge ${f}" title="Percentuale partite nel ruolo assegnato">${b}</span>
              <span class="player-elo">${Math.round(g(e,a==="defence"))} <span style="font-size:0.85em;opacity:0.7;">(${z(e)})</span></span>
            </div>
          </div>
        </div>
        <div class="player-item">
          <div class="match-player-grid">
            <div class="match-player-avatar">
              <img 
                src="${F}avatars/${n.id}.webp" 
                alt="${n.name}"
                class="match-avatar-img"
                onerror="this.src='${y}'"
              />
            </div>
            <div class="match-player-name"><span class="player-name">${v} ${n.name}</span></div>
            <div class="match-player-meta">
              <span class="role-badge ${C}" title="Percentuale partite nel ruolo assegnato">${M}</span>
              <span class="player-elo">${Math.round(g(n,c==="defence"))} <span style="font-size:0.85em;opacity:0.7;">(${z(n)})</span></span>
            </div>
          </div>
        </div>
      </div>
    `,s}static createScoreInputs(){const t=document.createElement("div");return t.className="scores-container",t.innerHTML=`
      <input type="number" name="scoreTeamA" min="0" max="8" required placeholder="0" class="score-input" />
      <span class="score-separator">-</span>
      <input type="number" name="scoreTeamB" min="0" max="8" required placeholder="0" class="score-input" />
    `,t}static createSaveMatchForm(t){const e=document.createElement("form");e.className="save-match-form-old";const a=document.createElement("h4");a.textContent="Inserisci il punteggio",e.appendChild(a);const n=document.createElement("div");n.className="scores-container";const c=document.createElement("div");c.className="score-group";const o=document.createElement("label");o.textContent="Punteggio Team A",o.htmlFor="score-team-a";const r=document.createElement("input");r.type="number",r.id="score-team-a",r.name="scoreTeamA",r.min="0",r.max="8",r.required=!0,c.appendChild(o),c.appendChild(r);const s=document.createElement("div");s.className="score-group";const d=document.createElement("label");d.textContent="Punteggio Team B",d.htmlFor="score-team-b";const u=document.createElement("input");u.type="number",u.id="score-team-b",u.name="scoreTeamB",u.min="0",u.max="8",u.required=!0,s.appendChild(d),s.appendChild(u),n.appendChild(c),n.appendChild(s),e.appendChild(n);const m=document.createElement("button");return m.type="submit",m.textContent="Salva Partita",m.className="save-match-button",e.appendChild(m),e}static async deleteGeneratedMatch(){i.currentMatch=null,i.renderMatches([]),i.updateUI();try{await L()}catch(t){console.error("Failed to delete generated match",t)}}static async saveMatch(t){if(!i.currentMatch){alert("Nessuna partita da salvare.");return}const e=new FormData(t),a=Number.parseInt(e.get("scoreTeamA"),10),n=Number.parseInt(e.get("scoreTeamB"),10);if(Number.isNaN(a)||Number.isNaN(n)){alert("Inserisci punteggi validi per entrambi i team.");return}if(a<0||n<0||a>8||n>8){alert("I punteggi devono essere compresi tra 0 e 8.");return}if(a===n){alert("La partita non pu√≤ finire in parit√†. Inserisci punteggi diversi.");return}const c=i.currentMatch,o=c.teamA.defence,r=c.teamA.attack,s=c.teamB.defence,d=c.teamB.attack,u={defence:o.id,attack:r.id},m={defence:s.id,attack:d.id};try{const p=W(u,m,[a,n]);await q(p);try{await L()}catch(y){console.error("Errore durante la pulizia della partita generata:",y)}i.currentMatch=null,i.renderMatches([]),i.updateUI()}catch(p){console.error("Errore durante il salvataggio della partita:",p),alert("Errore durante il salvataggio della partita. Riprova.")}}}async function te(){await i.init()}$(te);
