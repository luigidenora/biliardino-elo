name: Scheduled Notifications

on:
  schedule:
    # Notifiche alle 10:45 e 15:45 ora italiana
    # Solo giorni lavorativi: Luned√¨-Venerd√¨ (1-5)
    # 
    # IMPORTANTE - Cambio ora legale:
    # GitHub Actions usa UTC. L'Italia passa tra CET (UTC+1) e CEST (UTC+2).
    # 
    # Configurazione attuale (CET - ora solare, ~fine ottobre a fine marzo):
    # - 9:45 UTC = 10:45 ora italiana
    # - 14:45 UTC = 15:45 ora italiana
    #
    # Per CEST (ora legale, ~fine marzo a fine ottobre), aggiornare a:
    # - cron: '45 8 * * 1-5'   # 8:45 UTC = 10:45 IT (CEST)
    # - cron: '45 13 * * 1-5'  # 13:45 UTC = 15:45 IT (CEST)
    #
    - cron: '45 9 * * 1-5'   # 9:45 UTC = 10:45 IT (CET)
    - cron: '45 14 * * 1-5'  # 14:45 UTC = 15:45 IT (CET)
  
  # Permetti attivazione manuale per testing
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Modalit√† test (non invia notifiche reali)'
        required: false
        default: false
        type: boolean

  # Permetti testing su pull request
  pull_request:
    paths:
      - '.github/workflows/cron.yml'

jobs:
  send-notifications:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log execution timestamp
        run: |
          echo "============================================="
          echo "üïê Workflow eseguito: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "üìÖ Ora italiana (CET): $(TZ='Europe/Rome' date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "üîÑ Trigger: ${{ github.event_name }}"
          echo "üè∑Ô∏è Branch: ${{ github.ref_name }}"
          echo "üìù Commit: ${{ github.sha }}"
          echo "============================================="

      - name: Trigger Vercel Cron Handler
        if: github.event_name != 'pull_request' && github.event.inputs.test_mode != 'true'
        run: |
          echo "üì¢ Invio richiesta a Vercel cron handler..."
          response=$(curl -s -w "\n%{http_code}" -X GET "${{ secrets.VERCEL_API_URL }}/api/cron-handler")
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          echo "üì• Response code: $http_code"
          echo "üìÑ Response body: $body"
          if [ "$http_code" -ge 400 ]; then
            echo "‚ùå Errore nella chiamata API"
            exit 1
          fi
          echo "‚úÖ Cron handler chiamato con successo"

      - name: Test mode - Skip notification
        if: github.event_name == 'pull_request' || github.event.inputs.test_mode == 'true'
        run: |
          echo "üß™ MODALIT√Ä TEST - Notifiche NON inviate"
          echo "   Questo √® un test per verificare che il workflow funziona correttamente."
          echo "   In produzione (scheduled/workflow_dispatch senza test_mode), le notifiche verranno inviate."
          echo ""
          echo "üìã Riepilogo configurazione:"
          echo "   - Schedule: 10:45 e 15:45 ora italiana (Lun-Ven)"
          echo "   - Cron UTC: 9:45 e 14:45 (durante CET)"
          echo "   - Endpoint: /api/cron-handler"
          echo ""
          echo "‚úÖ Test completato con successo!"
