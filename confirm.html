<!doctype html>
<html lang="it">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Conferma Partecipazione - CAlcio Balilla</title>
  <meta name="theme-color" content="#f5f5f7" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" type="image/png" href="./icons/icon-192.jpg" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', 'Inter', system-ui, sans-serif;
      background: linear-gradient(135deg, #f5f5f7 0%, #e8e8ed 100%);
      background-attachment: fixed;
      color: #1d1d1f;
      min-height: 100vh;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      -webkit-font-smoothing: antialiased;
      overflow: hidden;
      position: relative;
    }

    /* ====== Aquarium layer (behind content) ====== */
    #aquarium {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      overflow: hidden;
    }

    /* ====== Each fish wrapper ====== */
    .fish {
      position: absolute;
      display: flex;
      flex-direction: column;
      align-items: center;
      will-change: transform;
      z-index: 1;
    }

    .fish-sprite {
      font-size: 2rem;
      line-height: 1;
      filter: drop-shadow(0 2px 6px rgba(0, 0, 0, 0.1));
      transition: transform 0.3s;
    }

    .fish.flipped .fish-sprite {
      transform: scaleX(-1);
    }

    /* Figma-style cursor label */
    .fish-label {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      margin-top: 4px;
      padding: 3px 10px;
      border-radius: 8px;
      font-size: 0.7rem;
      font-weight: 700;
      white-space: nowrap;
      color: #fff;
      pointer-events: none;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      opacity: 0.92;
    }

    .fish-label::before {
      content: '';
      position: absolute;
      top: -4px;
      left: 50%;
      transform: translateX(-50%);
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
      border-bottom: 5px solid var(--label-color);
    }

    /* Fish swim animations â€” randomized per-fish via inline style */
    @keyframes swim-h {
      0% {
        left: var(--start-x);
      }

      100% {
        left: var(--end-x);
      }
    }

    @keyframes bob {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(var(--bob-y, -12px));
      }
    }

    .fish {
      animation:
        swim-h var(--dur) linear infinite alternate,
        bob var(--bob-dur) ease-in-out infinite;
      top: var(--y);
    }

    /* ====== God rays ====== */
    .god-rays {
      position: fixed;
      top: -40%;
      left: 50%;
      width: 200%;
      height: 140%;
      transform: translateX(-50%);
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }

    .god-ray {
      position: absolute;
      top: 0;
      width: var(--ray-w, 120px);
      height: 120%;
      background: linear-gradient(180deg,
          rgba(100, 180, 255, 0.12) 0%,
          rgba(100, 180, 255, 0.04) 40%,
          transparent 80%);
      transform-origin: top center;
      transform: rotate(var(--ray-angle, 0deg));
      animation: ray-sway var(--ray-dur, 8s) ease-in-out infinite alternate;
      opacity: var(--ray-opacity, 0.5);
      filter: blur(8px);
    }

    @keyframes ray-sway {
      0% {
        transform: rotate(var(--ray-angle, 0deg)) translateX(-10px);
        opacity: var(--ray-opacity, 0.5);
      }

      100% {
        transform: rotate(var(--ray-angle, 0deg)) translateX(10px);
        opacity: calc(var(--ray-opacity, 0.5) * 0.6);
      }
    }

    /* ====== Rising bubbles ====== */
    .bubble {
      position: absolute;
      bottom: -20px;
      border-radius: 50%;
      background: radial-gradient(ellipse at 30% 30%,
          rgba(60, 150, 255, 0.55),
          rgba(60, 150, 255, 0.1));
      border: 1px solid rgba(60, 150, 255, 0.35);
      box-shadow: inset 0 -2px 6px rgba(60, 150, 255, 0.3), 0 0 8px rgba(60, 150, 255, 0.12);
      animation: rise var(--rise-dur) ease-in infinite;
      animation-delay: var(--rise-delay);
      opacity: 0;
      pointer-events: none;
    }

    @keyframes rise {
      0% {
        opacity: 0;
        transform: translateX(0) scale(0.7);
        bottom: -20px;
      }

      10% {
        opacity: 0.6;
      }

      70% {
        opacity: 0.3;
      }

      100% {
        opacity: 0;
        transform: translateX(var(--drift, 15px)) scale(1.05);
        bottom: 105%;
      }
    }

    /* ====== Seabed hint ====== */
    .seabed {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: linear-gradient(180deg, transparent 0%, rgba(100, 160, 220, 0.06) 50%, rgba(100, 160, 220, 0.12) 100%);
      z-index: 1;
      pointer-events: none;
    }

    .seabed-deco {
      position: absolute;
      bottom: 4px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 1.2rem;
      letter-spacing: 2.5rem;
      opacity: 0.3;
      pointer-events: none;
    }

    /* ====== Top status bar ====== */
    .top-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 50;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      padding: 0.6rem 1rem;
      padding-top: max(0.6rem, env(safe-area-inset-top));
      background: rgba(249, 249, 249, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(0, 0, 0, 0.06);
    }

    .top-bar-time {
      font-size: 0.9rem;
      font-weight: 700;
      color: #1d1d1f;
      letter-spacing: -0.3px;
    }

    .top-bar-status {
      font-size: 0.75rem;
      font-weight: 600;
      color: #34c759;
    }

    /* ====== Content layer ====== */
    .page-scroll {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1.5rem 1rem;
      padding-bottom: 6.5rem;
      position: relative;
      z-index: 2;
    }

    .container {
      text-align: center;
      max-width: 420px;
      width: 100%;
      padding: 2rem 1.5rem;
      position: relative;
    }

    /* ====== Hero watermark (behind fish) ====== */
    .time-watermark {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 0;
      pointer-events: none;
      font-size: 8rem;
      font-weight: 800;
      color: rgba(6, 44, 125, 0.08);
      letter-spacing: -4px;
      line-height: 1;
      white-space: nowrap;
      user-select: none;
    }

    /* ====== Status (in top bar) ====== */
    .status-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
    }

    .count-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.3rem 0.9rem;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      font-size: 0.85rem;
      font-weight: 700;
      color: #1d1d1f;
      border: 1px solid rgba(0, 0, 0, 0.06);
    }

    .count-pill .num {
      font-size: 1.1rem;
      font-weight: 800;
    }

    /* ====== Sticky CTA ====== */
    .cta-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 0.75rem 1rem;
      padding-bottom: max(0.75rem, env(safe-area-inset-bottom));
      background: rgba(249, 249, 249, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid rgba(0, 0, 0, 0.06);
      z-index: 100;
      display: flex;
      justify-content: center;
    }

    .btn {
      display: block;
      width: 100%;
      max-width: 420px;
      padding: 1rem 2rem;
      font-size: 1.15rem;
      font-weight: 700;
      color: #fff;
      background: linear-gradient(135deg, #062c7d 0%, #1a4aad 50%, #2563d4 100%);
      border: none;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 24px rgba(6, 44, 125, 0.3);
      -webkit-tap-highlight-color: transparent;
      letter-spacing: 0.2px;
    }

    .btn:hover {
      background: linear-gradient(135deg, #0a3592 0%, #1e52b8 50%, #2d6ddf 100%);
      transform: translateY(-1px);
      box-shadow: 0 6px 32px rgba(6, 44, 125, 0.4);
    }

    .btn:active {
      transform: scale(0.98);
      box-shadow: 0 2px 12px rgba(6, 44, 125, 0.2);
    }

    .btn:disabled {
      background: linear-gradient(135deg, #b0b0b0, #ccc);
      color: #888;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    /* ====== States ====== */
    .loading-container {
      padding: 2rem 0;
    }

    .spinner {
      width: 36px;
      height: 36px;
      margin: 0 auto 0.75rem;
      border: 3px solid rgba(0, 0, 0, 0.08);
      border-top-color: #34c759;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .status-text {
      font-size: 0.95rem;
      color: #6e6e73;
    }

    .page-icon {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }

    .success {
      color: #2e7d32;
    }

    .error {
      color: #d32f2f;
    }

    .back-link {
      margin-top: 1.25rem;
      font-size: 0.85rem;
    }

    .back-link a {
      color: #6e6e73;
      text-decoration: none;
      font-weight: 600;
      transition: color 0.2s;
    }

    .back-link a:hover {
      color: #1d1d1f;
    }

    /* ====== Responsive ====== */
    @media (max-width: 380px) {
      .time-watermark {
        font-size: 5.5rem;
      }

      .btn {
        font-size: 1rem;
        padding: 0.875rem 1.5rem;
      }

      .fish-sprite {
        font-size: 1.5rem;
      }
    }

    @media (min-height: 700px) {
      .page-scroll {
        justify-content: center;
      }
    }

    @media (max-height: 550px) {
      .page-scroll {
        justify-content: flex-start;
        padding-top: 1rem;
      }
    }
  </style>
</head>

<body>
  <!-- God rays -->
  <div class="god-rays" id="god-rays"></div>

  <!-- Aquarium: fish + bubbles spawn here -->
  <div id="aquarium"></div>

  <!-- Time watermark behind fish -->
  <div class="time-watermark" id="time-watermark">--:--</div>

  <!-- Sandy seabed at bottom -->
  <div class="seabed">
    <div class="seabed-deco">ğŸª¸ğŸŒ¿ğŸšğŸª¨ğŸŒŠ</div>
  </div>

  <!-- Top status bar -->
  <div class="top-bar" id="top-bar" style="display:none">
    <span class="top-bar-time" id="top-bar-time">âš½ 11:00</span>
    <div class="count-pill">
      <span>ğŸŸ</span>
      <span class="num" id="queue-count">0</span>
      <span>/ 5</span>
    </div>
    <span class="top-bar-status" id="top-bar-status"></span>
  </div>

  <div class="page-scroll">
    <div class="container">

      <!-- Loading -->
      <div id="loading-state" class="loading-container">
        <div class="spinner"></div>
        <p class="status-text">Caricamento...</p>
      </div>

      <!-- Confirm state -->
      <div id="confirm-state" style="display: none;"></div>

      <!-- Success -->
      <div id="success-state" style="display: none;">
        <div class="page-icon">âœ…</div>
        <p class="status-text success" style="font-weight:700;font-size:1.15rem;margin-bottom:0.25rem;">Confermato!</p>
        <p class="status-text">Aspetta il matchmaking...</p>
        <div class="back-link">
          <a href="./index.html">â† Torna alla home</a>
        </div>
      </div>

      <!-- Error -->
      <div id="error-state" style="display: none;">
        <div class="page-icon">âŒ</div>
        <p class="status-text error" id="error-message" style="font-weight:700;">Errore nella conferma</p>
        <div class="back-link">
          <a href="./index.html">â† Torna alla home</a>
        </div>
      </div>

    </div>
  </div>

  <!-- Sticky CTA -->
  <div class="cta-footer" id="cta-footer">
    <button id="confirm-btn" class="btn">ğŸŒŠ Ci sono!</button>
    <button id="retry-btn" class="btn" style="display:none">â†» Riprova</button>
  </div>

  <script type="module">
    const urlParams = new URLSearchParams(window.location.search);
    const matchTime = urlParams.get('time') || getNextMatchTime();
    const confirmation = urlParams.get('c');
    const MIN_PLAYERS = 5;
    const myPlayerId = localStorage.getItem('biliardino_player_id');

    const confirmBtn = document.getElementById('confirm-btn');
    const retryBtn = document.getElementById('retry-btn');
    const ctaFooter = document.getElementById('cta-footer');
    const aquarium = document.getElementById('aquarium');
    const topBar = document.getElementById('top-bar');

    // â”€â”€â”€ Fish / sea creature emoji pool â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const FISH_POOL = ['ğŸŸ', 'ğŸ ', 'ğŸ¡', 'ğŸ¦ˆ', 'ğŸ™', 'ğŸ¦‘', 'ğŸ³', 'ğŸ¬', 'ğŸ¦', 'ğŸš'];
    // Figma-style label colors â€” one per fish, cycling
    const LABEL_COLORS = [
      '#1e90ff', '#e74c3c', '#8e44ad', '#e67e22', '#2ecc71',
      '#f39c12', '#16a085', '#c0392b', '#2980b9', '#d35400'
    ];

    // Track current fish on screen: Map<playerId, HTMLElement>
    const fishMap = new Map();

    function getNextMatchTime() {
      const now = new Date();
      const mins = now.getHours() * 60 + now.getMinutes();
      if (mins < 660) return '11:00';
      if (mins < 960) return '16:00';
      return '11:00';
    }

    function formatTimeAgo(isoDate) {
      const diff = Date.now() - new Date(isoDate).getTime();
      const mins = Math.floor(diff / 60000);
      if (mins < 1) return 'adesso';
      if (mins === 1) return '1 min fa';
      return `${mins} min fa`;
    }

    function showState(state) {
      ['loading-state', 'confirm-state', 'success-state', 'error-state'].forEach(id => {
        document.getElementById(id).style.display = 'none';
      });
      document.getElementById(`${state}-state`).style.display = 'block';
      confirmBtn.style.display = state === 'confirm' ? 'block' : 'none';
      retryBtn.style.display = state === 'error' ? 'block' : 'none';
      ctaFooter.style.display = (state === 'confirm' || state === 'error') ? 'flex' : 'none';
      topBar.style.display = state === 'confirm' ? 'flex' : 'none';
    }

    // â”€â”€â”€ Aquarium fish system â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function rand(min, max) { return Math.random() * (max - min) + min; }

    function spawnFish(playerId, name, index) {
      if (fishMap.has(playerId)) return; // already swimming

      const isMe = String(playerId) === String(myPlayerId);
      const emoji = isMe ? 'ğŸ¦ˆ' : FISH_POOL[index % FISH_POOL.length];
      const labelColor = LABEL_COLORS[index % LABEL_COLORS.length];
      const size = isMe ? 2.6 : rand(1.6, 2.4);

      // Random swim parameters
      const goRight = Math.random() > 0.5;
      const startX = goRight ? rand(-10, 15) : rand(60, 95);
      const endX = goRight ? rand(60, 95) : rand(-10, 15);
      // Swim across entire screen, no restricted bands
      const yPos = rand(5, 85);
      const dur = rand(10, 22);
      const bobDur = rand(2.5, 5);
      const bobY = rand(-8, -18);
      const delay = rand(0, 3);

      const fish = document.createElement('div');
      fish.className = `fish ${goRight ? '' : 'flipped'}`;
      fish.style.cssText = `
        --start-x: ${startX}%;
        --end-x: ${endX}%;
        --y: ${yPos}%;
        --dur: ${dur}s;
        --bob-dur: ${bobDur}s;
        --bob-y: ${bobY}px;
        animation-delay: ${delay}s, ${delay}s;
      `;

      fish.innerHTML = `
        <span class="fish-sprite" style="font-size:${size}rem">${emoji}</span>
        <span class="fish-label" style="background:${labelColor};--label-color:${labelColor}">
          ${isMe ? 'ğŸ™‹ Tu' : name}
        </span>
      `;

      aquarium.appendChild(fish);
      fishMap.set(playerId, fish);
    }

    function removeFish(playerId) {
      const fish = fishMap.get(playerId);
      if (!fish) return;
      fish.style.transition = 'opacity 0.5s';
      fish.style.opacity = '0';
      setTimeout(() => { fish.remove(); fishMap.delete(playerId); }, 500);
    }

    function syncFish(confirmations) {
      const activeIds = new Set(confirmations.map(c => c.playerId));

      // Remove fish that are no longer confirmed
      for (const id of fishMap.keys()) {
        if (!activeIds.has(id)) removeFish(id);
      }

      // Spawn new fish
      const sorted = [...confirmations].sort(
        (a, b) => new Date(a.confirmedAt).getTime() - new Date(b.confirmedAt).getTime()
      );
      sorted.forEach((conf, i) => {
        const isMe = String(conf.playerId) === String(myPlayerId);
        const name = isMe ? 'ğŸ™‹ Tu' : `Giocatore #${conf.playerId}`;
        spawnFish(conf.playerId, name, i);
      });
    }

    // â”€â”€â”€ Bubbles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function spawnBubbles() {
      const count = 18;
      for (let i = 0; i < count; i++) {
        const b = document.createElement('div');
        b.className = 'bubble';
        const size = rand(8, 26);
        b.style.cssText = `
          width: ${size}px;
          height: ${size}px;
          left: ${rand(3, 97)}%;
          --rise-dur: ${rand(7, 16)}s;
          --rise-delay: ${rand(0, 10)}s;
          --drift: ${rand(-30, 30)}px;
        `;
        aquarium.appendChild(b);
      }
    }

    function spawnGodRays() {
      const container = document.getElementById('god-rays');
      const rays = 5;
      for (let i = 0; i < rays; i++) {
        const r = document.createElement('div');
        r.className = 'god-ray';
        const angle = rand(-25, 25);
        r.style.cssText = `
          left: ${rand(10, 90)}%;
          --ray-w: ${rand(80, 200)}px;
          --ray-angle: ${angle}deg;
          --ray-dur: ${rand(6, 14)}s;
          --ray-opacity: ${rand(0.3, 0.7)};
        `;
        container.appendChild(r);
      }
    }

    // â”€â”€â”€ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function loadConfirmations() {
      try {
        const res = await fetch(`${import.meta.env.VITE_API_BASE_URL}/get-confirmations?time=` + matchTime);
        const data = await res.json();
        const count = data.count || 0;

        document.getElementById('queue-count').textContent = count;

        const statusEl = document.getElementById('top-bar-status');
        statusEl.textContent = count >= MIN_PLAYERS ? 'Si gioca! âš½' : '';

        // Sync the aquarium
        if (data.confirmations && data.confirmations.length > 0) {
          syncFish(data.confirmations);
        } else {
          // Remove all fish
          for (const id of fishMap.keys()) removeFish(id);
        }
      } catch (err) {
        console.error('Errore caricamento conferme:', err);
      }
    }

    async function init() {
      spawnBubbles();
      spawnGodRays();
      await loadConfirmations();
      showState('confirm');
      const intervalId = setInterval(loadConfirmations, 5000);
      setTimeout(() => clearInterval(intervalId), 60_000);
    }

    async function confirmAttendance() {
      confirmBtn.disabled = true;
      confirmBtn.textContent = 'â³ Confermando...';

      try {
        const res = await fetch(`${import.meta.env.VITE_API_BASE_URL}/confirm-availability`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ matchTime, playerId: myPlayerId, subscription: localStorage.getItem('biliardino_subscription') })
        });
        if (!res.ok) throw new Error('Errore nella conferma');
        showState('success');
      } catch (err) {
        document.getElementById('error-message').textContent = err.message || 'Errore nella conferma';
        showState('error');
      }
    }

    async function autoConfirm() {
      showState('confirm');
      await confirmAttendance();
    }

    if (confirmation === 'true') {
      await autoConfirm();
    } else if (confirmation === 'false') {
      showState('error');
      document.getElementById('error-message').textContent = 'Hai rifiutato la partecipazione alla partita.';
    }
    document.getElementById('time-watermark').textContent = matchTime;
    document.getElementById('top-bar-time').textContent = `âš½ ${matchTime}`;
    confirmBtn.textContent = `ğŸŒŠ Ci sono!`;

    confirmBtn.addEventListener('click', confirmAttendance);
    retryBtn.addEventListener('click', () => {
      confirmBtn.disabled = false;
      confirmBtn.textContent = `ğŸŒŠ Ci sono!`;
      showState('confirm');
    });

    init();
  </script>
</body>

</html>