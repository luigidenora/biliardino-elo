<!doctype html>
<html lang="it">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Test Notifiche - CA Biliardino</title>
  <meta name="theme-color" content="#062c7d" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles/ranking.css" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Inter', sans-serif;
      padding: 2rem;
      max-width: 900px;
      margin: 0 auto;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .test-container {
      background: white;
      border-radius: 18px;
      padding: 2rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
    }

    h1 {
      color: #1d1d1f;
      margin-bottom: 0.5rem;
    }

    .subtitle {
      color: #6e6e73;
      font-size: 0.95rem;
      margin-bottom: 2rem;
    }

    .back-button {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      color: #007aff;
      text-decoration: none;
      font-weight: 600;
      margin-bottom: 1.5rem;
      font-size: 0.95rem;
      transition: all 0.2s ease;
    }

    .back-button:hover {
      transform: translateX(-4px);
    }

    .test-section {
      background: #f5f5f7;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .test-section h2 {
      font-size: 1.25rem;
      color: #1d1d1f;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .form-group label {
      font-weight: 600;
      color: #1d1d1f;
      font-size: 0.9rem;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      padding: 0.75rem;
      border: 1px solid #d2d2d7;
      border-radius: 8px;
      font-size: 1rem;
      font-family: inherit;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .test-btn {
      background: #007aff;
      color: white;
      border: none;
      padding: 1rem 1.5rem;
      border-radius: 12px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.2s ease;
      width: 100%;
    }

    .test-btn:hover {
      background: #0051d5;
      transform: scale(1.02);
    }

    .test-btn:active {
      transform: scale(0.98);
    }

    .test-btn:disabled {
      background: #d2d2d7;
      cursor: not-allowed;
      transform: none;
    }

    .test-btn.success {
      background: #30d158;
    }

    .test-btn.success:hover {
      background: #28a745;
    }

    .test-btn.danger {
      background: #ff3b30;
    }

    .test-btn.danger:hover {
      background: #cc2e24;
    }

    .section-divider {
      height: 1px;
      background: #d2d2d7;
      margin: 2rem 0;
    }

    .result-message {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 8px;
      font-size: 0.9rem;
    }

    .result-message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .result-message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .result-message.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .hidden {
      display: none;
    }

    .help-text {
      font-size: 0.85rem;
      color: #6e6e73;
      margin-top: 0.25rem;
    }

    .production-badge {
      display: inline-block;
      background: #ff3b30;
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
  </style>
</head>

<body>
  <div class="test-container">
    <a href="./index.html" class="back-button">‚Üê Torna alla Home</a>
    <h1>üîî Test Notifiche <span class="production-badge">Production</span></h1>
    <p class="subtitle">Interfaccia di testing per le notifiche push con Vercel Blob Storage</p>

    <!-- 1. Add Subscription -->
    <div class="test-section">
      <h2>‚ûï Aggiungi Subscription</h2>
      <div class="form-group">
        <label for="add-player-id">Player ID</label>
        <input type="number" id="add-player-id" placeholder="Es: 42" />
        <span class="help-text">ID numerico del giocatore</span>
      </div>
      <div class="form-group">
        <label for="add-player-name">Nome Giocatore</label>
        <input type="text" id="add-player-name" placeholder="Es: Mario Rossi" />
        <span class="help-text">Nome completo del giocatore</span>
      </div>
      <button id="add-subscription-btn" class="test-btn success">
        ‚ûï Aggiungi Subscription
      </button>
      <div id="add-result" class="result-message hidden"></div>
    </div>

    <div class="section-divider"></div>

    <!-- 2. Test Subscription by User ID -->
    <div class="test-section">
      <h2>üß™ Test Subscription by User ID</h2>
      <div class="form-row">
        <div class="form-group">
          <label for="test-player-id">Player ID</label>
          <input type="number" id="test-player-id" placeholder="Es: 42" />
        </div>
        <div class="form-group">
          <label for="test-title">Titolo</label>
          <input type="text" id="test-title" placeholder="Test Notifica" value="üéÆ Partita Iniziata!" />
        </div>
      </div>
      <div class="form-group">
        <label for="test-body">Messaggio</label>
        <textarea id="test-body"
          placeholder="Inserisci il messaggio della notifica">La tua partita sta per iniziare!</textarea>
      </div>
      <div class="form-group">
        <label for="test-url">URL (opzionale)</label>
        <input type="text" id="test-url" placeholder="/matchmaking.html" value="/matchmaking.html" />
        <span class="help-text">Pagina da aprire quando si clicca la notifica</span>
      </div>
      <button id="test-by-user-btn" class="test-btn">
        üöÄ Invia Test Notifica
      </button>
      <div id="test-user-result" class="result-message hidden"></div>
    </div>

    <div class="section-divider"></div>

    <!-- 3. Test Broadcast -->
    <div class="test-section">
      <h2>üì¢ Test Broadcast</h2>
      <div class="form-group">
        <label for="broadcast-time">Orario Partita</label>
        <input type="text" id="broadcast-time" placeholder="Es: 14:30" value="14:30" />
        <span class="help-text">Orario della partita in formato HH:MM</span>
      </div>
      <div class="form-group">
        <label for="broadcast-title">Titolo (opzionale)</label>
        <input type="text" id="broadcast-title" placeholder="Lascia vuoto per usare il default" />
      </div>
      <div class="form-group">
        <label for="broadcast-body">Messaggio (opzionale)</label>
        <textarea id="broadcast-body" placeholder="Lascia vuoto per usare il default"></textarea>
      </div>
      <button id="test-broadcast-btn" class="test-btn danger">
        üì¢ Invia Broadcast a Tutti
      </button>
      <div id="broadcast-result" class="result-message hidden"></div>
    </div>
  </div>

  <script type="module">
    import { subscribeToPushNotifications } from './src/pwa.ts';

    // Helper function to show result messages
    function showResult(elementId, message, type = 'success') {
      const el = document.getElementById(elementId);
      if (el) {
        el.textContent = message;
        el.className = `result-message ${type}`;
        el.classList.remove('hidden');
        setTimeout(() => el.classList.add('hidden'), 10000);
      }
    }

    // 1. Add Subscription
    document.getElementById('add-subscription-btn')?.addEventListener('click', async () => {
      const playerIdInput = document.getElementById('add-player-id');
      const playerNameInput = document.getElementById('add-player-name');
      const playerId = playerIdInput.value.trim();
      const playerName = playerNameInput.value.trim();

      if (!playerId || !playerName) {
        showResult('add-result', '‚ùå Inserisci Player ID e Nome Giocatore', 'error');
        return;
      }

      if (isNaN(Number(playerId))) {
        showResult('add-result', '‚ùå Player ID deve essere un numero', 'error');
        return;
      }

      try {
        // Save to localStorage
        localStorage.setItem('biliardino_player_id', playerId);
        localStorage.setItem('biliardino_player_name', playerName);

        // Request notification permission and create subscription
        await subscribeToPushNotifications();

        showResult('add-result', `‚úÖ Subscription creata con successo per ${playerName} (ID: ${playerId})`, 'success');
        
        // Clear inputs
        playerIdInput.value = '';
        playerNameInput.value = '';
      } catch (err) {
        console.error('Errore creazione subscription:', err);
        showResult('add-result', `‚ùå Errore: ${err.message}`, 'error');
      }
    });

    // 2. Test Subscription by User ID
    document.getElementById('test-by-user-btn')?.addEventListener('click', async () => {
      const playerId = document.getElementById('test-player-id').value.trim();
      const title = document.getElementById('test-title').value.trim();
      const body = document.getElementById('test-body').value.trim();
      const url = document.getElementById('test-url').value.trim();

      if (!playerId) {
        showResult('test-user-result', '‚ùå Inserisci un Player ID', 'error');
        return;
      }

      if (!title || !body) {
        showResult('test-user-result', '‚ùå Inserisci titolo e messaggio', 'error');
        return;
      }

      try {
        const response = await fetch('/api/send-notification', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            playerId: Number(playerId),
            title,
            body,
            url: url || '/matchmaking.html',
            requireInteraction: true
          })
        });

        if (response.ok) {
          const result = await response.json();
          showResult('test-user-result', `‚úÖ Notifica inviata con successo a Player ID ${playerId}`, 'success');
        } else {
          const error = await response.text();
          showResult('test-user-result', `‚ùå Errore: ${error}`, 'error');
        }
      } catch (err) {
        console.error('Errore invio notifica:', err);
        showResult('test-user-result', `‚ùå Errore: ${err.message}`, 'error');
      }
    });

    // 3. Test Broadcast
    document.getElementById('test-broadcast-btn')?.addEventListener('click', async () => {
      const matchTime = document.getElementById('broadcast-time').value.trim();
      const customTitle = document.getElementById('broadcast-title').value.trim();
      const customBody = document.getElementById('broadcast-body').value.trim();

      if (!matchTime) {
        showResult('broadcast-result', '‚ùå Inserisci l\'orario della partita', 'error');
        return;
      }

      // Validate time format
      if (!/^\d{1,2}:\d{2}$/.test(matchTime)) {
        showResult('broadcast-result', '‚ùå Formato orario non valido. Usa HH:MM (es: 14:30)', 'error');
        return;
      }

      try {
        const requestBody = { matchTime };
        if (customTitle) requestBody.title = customTitle;
        if (customBody) requestBody.body = customBody;

        const response = await fetch('/api/send-broadcast', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });

        if (response.ok) {
          const result = await response.json();
          showResult('broadcast-result', 
            `‚úÖ Broadcast inviato! ${result.sent || 0} notifiche inviate su ${result.total || 0} subscriptions`, 
            'success');
        } else {
          const error = await response.text();
          showResult('broadcast-result', `‚ùå Errore: ${error}`, 'error');
        }
      } catch (err) {
        console.error('Errore broadcast:', err);
        showResult('broadcast-result', `‚ùå Errore: ${err.message}`, 'error');
      }
    });
  </script>
</body>

</html>
